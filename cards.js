const storyData = {
    hearts: {
        suit: '♥',
        cards: [
            {
                title: "Geometric Prelude",
                texts: [
                "The line is made up of an infinite number of points; the plane of an infinite number of lines; the volume of an infinite number of planes; the hypervolume of an infinite number of volumes. . . . No, unquestionably this is not — more geometrico — the best way of beginning my story. To claim that it is true is nowadays the convention of every made-up story. Mine, however, is true."
                ]
            },
            {
                title: "The Gray Stranger",
                texts: [
                "I live alone in a fourth-floor apartment on Belgrano Street, in Buenos Aires. Late one evening, a few months back, I heard a knock at my door. I opened it and a stranger stood there. He was a tall man, with nondescript features — or perhaps it was my myopia that made them seem that way. Dressed in gray and carrying a gray suitcase in his hand, he had an unassuming look about him. I saw at once that he was a foreigner. At first, he struck me as old; only later did I realize that I had been misled by his thin blond hair, which was, in a Scandinavian sort of way, almost white. During the course of our conversation, which was not to last an hour, I found out that he came from the Orkneys."
                ]
            },
            {
                title: "The Invitation",
                texts: [
                "I invited him in, pointing to a chair. He paused awhile before speaking. A kind of gloom emanated from him — as it does now from me. \"I sell Bibles,\" he said. Somewhat pedantically, I replied, \"In this house are several English Bibles, including the first — John Wiclif's. I also have Cipriano de Valera's, Luther's — which, from a literary viewpoint, is the worst — and a Latin copy of the Vulgate. As you see, it's not exactly Bibles I stand in need of.\""
                ]
            },
            {
                title: "A Holy Book from Bikaner",
                texts: [
                "After a few moments of silence, he said, \"I don't only sell Bibles. I can show you a holy book I came across on the outskirts of Bikaner. It may interest you.\" He opened the suitcase and laid the book on a table. It was an octavo volume, bound in cloth. There was no doubt that it had passed through many hands. Examining it, I was surprised by its unusual weight. On the spine were the words \"Holy Writ\" and, below them, \"Bombay.\" \"Nineteenth century, probably,\" I remarked. \"I don't know,\" he said. \"I've never found out.\""
                ]
            },
            {
                title: "Strange Pages",
                texts: [
                "I opened the book at random. The script was strange to me. The pages, which were worn and typographically poor, were laid out in double columns, as in a Bible. The text was closely printed, and it was ordered in versicles. In the upper corners of the pages were Arabic numbers. I noticed that one left-hand page bore the number (let us say) 40,514 and the facing right-hand page 999. I turned the leaf; it was numbered with eight digits. It also bore a small illustration, like the kind used in dictionaries — an anchor drawn with pen and ink, as if by a schoolboy's clumsy hand."
                ]
            },
            {
                title: "Look Closely",
                texts: [
                // Version 1 
                "It was at this point that the stranger said, \"Look at the illustration closely. You'll never see it again.\" I noted my place and closed the book. At once, I reopened it. Page by page, in vain, I looked for the illustration of the anchor. \"It seems to be a version of Scriptures in some Indian language, is it not?\" I said to hide my dismay. \"No,\" he replied. Then, as if confiding a secret, he lowered his voice. \"I acquired the book in a town out on the plain in exchange for a handful of rupees and a Bible. Its owner did not know how to read. I suspect that he saw the Book of Books as a talisman. He was of the lowest caste; nobody but other untouchables could tread his shadow without contamination. He told me his book was called the Book of Sand, because neither the book nor the sand has any beginning or end.\"",

                // Version 2 
                "That was when the stranger said, \"Look closely at the illustration. You will never see it again.\" I kept my place and shut the book, then opened it at once. Page after page I searched, uselessly, for the anchor. To conceal my unease, I said, \"It seems to be a version of Scripture in some Indian language, is it not?\" \"No,\" he answered. Then, like a man sharing something forbidden, he lowered his voice. \"I got it in a town on the plain, in exchange for a handful of rupees and a Bible. The man who owned it could not read. I think he treated the Book of Books like a talisman. He was of the lowest caste; only other untouchables could step into his shadow without being polluted. He told me it was called the Book of Sand, because neither the book nor the sand has a beginning or an end.\""
                ]
            },
            {
                title: "No Beginning, No End",
                texts: [
                "The stranger asked me to find the first page. I laid my left hand on the cover and, trying to put my thumb on the flyleaf, I opened the book. It was useless. Every time I tried, a number of pages came between the cover and my thumb. It was as if they kept growing from the book. \"Now find the last page.\" Again I failed. In a voice that was not mine, I barely managed to stammer, \"This can't be.\" Still speaking in a low voice, the stranger said, \"It can't be, but it is. The number of pages in this book is no more or less than infinite. None is the first page, none the last. I don't know why they're numbered in this arbitrary way. Perhaps to suggest that the terms of an infinite series admit any number.\""
                ]
            },
            {
                title: "Infinite Space, Infinite Time",
                texts: [
                "Then, as if he were thinking aloud, he said, \"If space is infinite, we may be at any point in space. If time is infinite, we may be at any point in time.\" His speculations irritated me. \"You are religious, no doubt?\" I asked him. \"Yes, I'm a Presbyterian. My conscience is clear. I am reasonably sure of not having cheated the native when I gave him the Word of God in exchange for his devilish book.\" I assured him that he had nothing to reproach himself for, and I asked if he were just passing through this part of the world. He replied that he planned to return to his country in a few days. It was then that I learned that he was a Scot from the Orkney Islands. I told him I had a great personal affection for Scotland, through my love of Stevenson and Hume. \"You mean Stevenson and Robbie Burns,\" he corrected."
                ]
            },
            {
                title: "The Transaction",
                texts: [
                "While we spoke, I kept exploring the infinite book. With feigned indifference, I asked, \"Do you intend to offer this curiosity to the British Museum?\" \"No. I'm offering it to you,\" he said, and he stipulated a rather high sum for the book. I answered, in all truthfulness, that such a sum was out of my reach, and I began thinking. After a minute or two, I came up with a scheme. \"I propose a swap,\" I said. \"You got this book for a handful of rupees and a copy of the Bible. I'll offer you the amount of my pension check, which I've just collected, and my black-letter Wiclif Bible. I inherited it from my ancestors.\" \"A black-letter Wiclif!\" he murmured. I went to my bedroom and brought him the money and the book. He turned the leaves and studied the title page with all the fervor of a true bibliophile. \"It's a deal,\" he said."
                ]
            },
            {
                title: "The Departure",
                texts: [
                "It amazed me that he did not haggle. Only later was I to realize that he had entered my house with his mind made up to sell the book. Without counting the money, he put it away. We talked about India, about Orkney, and about the Norwegian jarls who once ruled it. It was night when the man left. I have not seen him again, nor do I know his name. I thought of keeping the Book of Sand in the space left on the shelf by the Wiclif, but in the end I decided to hide it behind the volumes of a broken set of The Thousand and One Nights. I went to bed and did not sleep. At three or four in the morning, I turned on the light. I got down the impossible book and leafed through its pages. On one of them I saw engraved a mask. The upper corner of the page carried a number, which I no longer recall, elevated to the ninth power."
                ]
            },
            {
                title: "Obsession",
                texts: [
                "I showed no one my treasure. To the luck of owning it was added the fear of having it stolen, and then the misgiving that it might not truly be infinite. These twin preoccupations intensified my old misanthropy. I had only a few friends left; I now stopped seeing even them. A prisoner of the book, I almost never went out anymore. After studying its frayed spine and covers with a magnifying glass, I rejected the possibility of a contrivance of any sort. The small illustrations, I verified, came two thousand pages apart. I set about listing them alphabetically in a notebook, which I was not long in filling up. Never once was an illustration repeated. At night, in the meager intervals my insomnia granted, I dreamed of the book."
                ]
            },
            {
                title: "Hidden in the Forest",
                texts: [
                "Summer came and went, and I realized that the book was monstrous. What good did it do me to think that I, who looked upon the volume with my eyes, who held it in my hands, was any less monstrous? I felt that the book was a nightmarish object, an obscene thing that affronted and tainted reality itself. I thought of fire, but I feared that the burning of an infinite book might likewise prove infinite and suffocate the planet with smoke. Somewhere I recalled reading that the best place to hide a leaf is in a forest. Before retirement, I worked on Mexico Street, at the Argentine National Library, which contains nine hundred thousand volumes. I knew that to the right of the entrance a curved staircase leads down into the basement, where books and maps and periodicals are kept. One day I went there and, slipping past a member of the staff and trying not to notice at what height or distance from the door, I lost the Book of Sand on one of the basement's musty shelves."
                ]
            }
]
    },

spades: {
    suit: '♠',
    cards: [
        {
            title: "The Arrival",
            text: "No one saw him disembark in the unanimous night, no one saw the bamboo canoe sink into the sacred mud, but in a few days there was no one who did not know that the taciturn man came from the South and that his home had been one of those numberless villages upstream in the deeply cleft side of the mountain, where the Zend language has not been contaminated by Greek and where leprosy is infrequent. What is certain is that the grey man kissed the mud, climbed up the bank with pushing aside (probably, without feeling) the blades which were lacerating his flesh, and crawled, nauseated and bloodstained, up to the circular enclosure crowned with a stone tiger or horse, which sometimes was the color of flame and now was that of ashes. This circle was a temple which had been devoured by ancient fires, profaned by the miasmal jungle, and whose god no longer received the homage of men. The stranger stretched himself out beneath the pedestal."
        },
        {
            title: "The Temple",
            text: "He was awakened by the sun high overhead. He was not astonished to find that his wounds had healed; he closed his pallid eyes and slept, not through weakness of flesh but through determination of will. He knew that this temple was the place required for his invincible intent; he knew that the incessant trees had not succeeded in strangling the ruins of another propitious temple downstream which had once belonged to gods now burned and dead; he knew that his immediate obligation was to dream. Toward midnight he was awakened by the inconsolable shriek of a bird. Tracks of bare feet, some figs and a jug warned him that the men of the region had been spying respectfully on his sleep, soliciting his protection or afraid of his magic. He felt a chill of fear, and sought out a sepulchral niche in the dilapidated wall where he concealed himself among unfamiliar leaves."
        },
        {
            title: "The Impossible Purpose",
            text: "The purpose which guided him was not impossible, though supernatural. He wanted to dream a man; he wanted to dream him in minute entirety and impose him on reality. This magic project had exhausted the entire expanse of his mind; if someone had asked him his name or to relate some event of his former life, he would not have been able to give an answer. This uninhabited, ruined temple suited him, for it is contained a minimum of visible world; the proximity of the workmen also suited him, for they took it upon themselves to provide for his frugal needs. The rice and fruit they brought him were nourishment enough for his body, which was consecrated to the sole task of sleeping and dreaming."
        },
        {
            title: "The Circular Amphitheater",
            text: "At first, his dreams were chaotic; then in a short while they became dialectic in nature. The stranger dreamed that he was in the center of a circular amphitheater which was more or less the burnt temple; clouds of taciturn students filled the tiers of seats; the faces of the farthest ones hung at a distance of many centuries and as high as the stars, but their features were completely precise. The man lectured his pupils on anatomy, cosmography, and magic: the faces listened anxiously and tried to answer understandingly, as if they guessed the importance of that examination which would redeem one of them from his condition of empty illusion and interpolate him into the real world. Asleep or awake, the man thought over the answers of his phantoms, did not allow himself to be deceived by imposters, and in certain perplexities he sensed a growing intelligence. He was seeking a soul worthy of participating in the universe."
        },
        {
            title: "The Chosen Pupil",
            text: "After nine or ten nights he understood with a certain bitterness that he could expect nothing from those pupils who accepted his doctrine passively, but that he could expect something from those who occasionally dared to oppose him. The former group, although worthy of love and affection, could not ascend to the level of individuals; the latter pre-existed to a slightly greater degree. One afternoon (now afternoons were also given over to sleep, now he was only awake for a couple hours at daybreak) he dismissed the vast illusory student body for good and kept only one pupil. He was a taciturn, sallow boy, at times intractable, and whose sharp features resembled of those of his dreamer. The brusque elimination of his fellow students did not disconcert him for long; after a few private lessons, his progress was enough to astound the teacher."
        },
        {
            title: "The Catastrophe of Wakefulness",
            text: "Nevertheless, a catastrophe took place. One day, the man emerged from his sleep as if from a viscous desert, looked at the useless afternoon light which he immediately confused with the dawn, and understood that he had not dreamed. All that night and all day long, the intolerable lucidity of insomnia fell upon him. He tried exploring the forest, to lose his strength; among the hemlock he barely succeeded in experiencing several short snatches of sleep, veined with fleeting, rudimentary visions that were useless. He tried to assemble the student body but scarcely had he articulated a few brief words of exhortation when it became deformed and was then erased. In his almost perpetual vigil, tears of anger burned his old eyes."
        },
        {
            title: "A New Method",
            text: "He understood that modeling the incoherent and vertiginous matter of which dreams are composed was the most difficult task that a man could undertake, even though he should penetrate all the enigmas of a superior and inferior order; much more difficult than weaving a rope out of sand or coining the faceless wind. He swore he would forget the enormous hallucination which had thrown him off at first, and he sought another method of work. Before putting it into execution, he spent a month recovering his strength, which had been squandered by his delirium. He abandoned all premeditation of dreaming and almost immediately succeeded in sleeping a reasonable part of each day. The few times that he had dreams during this period, he paid no attention to them. Before resuming his task, he waited until the moon's disk was perfect. Then, in the afternoon, he purified himself in the waters of the river, worshiped the planetary gods, pronounced the prescribed syllables of a mighty name, and went to sleep. He dreamed almost immediately, with his heart throbbing."
        },
        {
            title: "The Heart",
            text: "He dreamed that it was warm, secret, about the size of a clenched fist, and of a garnet color within the penumbra of a human body as yet without face or sex; during fourteen lucid nights he dreamt of it with meticulous love. Every night he perceived it more clearly. He did not touch it; he only permitted himself to witness it, to observe it, and occasionally to rectify it with a glance. He perceived it and lived it from all angles and distances. On the fourteenth night he lightly touched the pulmonary artery with his index finger, then the whole heart, outside and inside. He was satisfied with the examination. He deliberately did not dream for a night; he took up the heart again, invoked the name of a planet, and undertook the vision of another of the principle organs. Within a year he had come to the skeleton and the eyelids. The innumerable hair was perhaps the most difficult task. He dreamed an entire man--a young man, but who did not sit up or talk, who was unable to open his eyes. Night after night, the man dreamt him asleep."
        },
        {
            title: "The God of Fire",
            text: "In the Gnostic cosmogonies, demiurges fashion a red Adam who cannot stand; as a clumsy, crude and elemental as this Adam of dust was the Adam of dreams forged by the wizard's nights. One afternoon, the man almost destroyed his entire work, but then changed his mind. (It would have been better had he destroyed it.) When he had exhausted all supplications to the deities of earth, he threw himself at the feet of the effigy which was perhaps a tiger or perhaps a colt and implored its unknown help. That evening, at twilight, he dreamt of the statue. He dreamt it was alive, tremulous: it was not an atrocious bastard of a tiger and a colt, but at the same time these two firey creatures and also a bull, a rose, and a storm. This multiple god revealed to him that his earthly name was Fire, and that in this circular temple (and in others like it) people had once made sacrifices to him and worshiped him, and that he would magically animate the dreamed phantom, in such a way that all creatures, except Fire itself and the dreamer, would believe to be a man of flesh and blood. He commanded that once this man had been instructed in all the rites, he should be sent to the other ruined temple whose pyramids were still standing downstream, so that some voice would glorify him in that deserted edifice. In the dream of the man that dreamed, the dreamed one awoke."
        },
        {
            title: "The Years of Instruction",
            text: "The wizard carried out the orders he had been given. He devoted a certain length of time (which finally proved to be two years) to instructing him in the mysteries of the universe and the cult of fire. Secretly, he was pained at the idea of being separated from him. On the pretext of pedagogical necessity, each day he increased the number of hours dedicated to dreaming. He also remade the right shoulder, which was somewhat defective. At times, he was disturbed by the impression that all this had already happened . . . In general, his days were happy; when he closed his eyes, he thought: Now I will be with my son. Or, more rarely: The son I have engendered is waiting for me and will not exist if I do not go to him."
        },
        {
            title: "The Birth",
            text: "Gradually, he began accustoming him to reality. Once he ordered him to place a flag on a faraway peak. The next day the flag was fluttering on the peak. He tried other analogous experiments, each time more audacious. With a certain bitterness, he understood that his son was ready to be born--and perhaps impatient. That night he kissed him for the first time and sent him off to the other temple whose remains were turning white downstream, across many miles of inextricable jungle and marshes. Before doing this (and so that his son should never know that he was a phantom, so that he should think himself a man like any other) he destroyed in him all memory of his years of apprenticeship."
        },
        {
            title: "The Fire",
            text: "His victory and peace became blurred with boredom. In the twilight times of dusk and dawn, he would prostrate himself before the stone figure, perhaps imagining his unreal son carrying out identical rites in other circular ruins downstream; at night he no longer dreamed, or dreamed as any man does. His perceptions of the sounds and forms of the universe became somewhat pallid: his absent son was being nourished by these diminution of his soul. The purpose of his life had been fulfilled; the man remained in a kind of ecstasy. After a certain time, which some chronicles prefer to compute in years and others in decades, two oarsmen awoke him at midnight; he could not see their faces, but they spoke to him of a charmed man in a temple of the North, capable of walking on fire without burning himself. The wizard suddenly remembered the words of the god. He remembered that of all the creatures that people the earth, Fire was the only one who knew his son to be a phantom. This memory, which at first calmed him, ended by tormenting him. He feared lest his son should meditate on this abnormal privilege and by some means find out he was a mere simulacrum. Not to be a man, to be a projection of another man's dreams--what an incomparable humiliation, what madness! Any father is interested in the sons he has procreated (or permitted) out of the mere confusion of happiness; it was natural that the wizard should fear for the future of that son whom he had thought out entrail by entrail, feature by feature, in a thousand and one secret nights.\n\nHis misgivings ended abruptly, but not without certain forewarnings. First (after a long drought) a remote cloud, as light as a bird, appeared on a hill; then, toward the South, the sky took on the rose color of leopard's gums; then came clouds of smoke which rusted the metal of the nights; afterwards came the panic-stricken flight of wild animals. For what had happened many centuries before was repeating itself. The ruins of the sanctuary of the god of Fire was destroyed by fire. In a dawn without birds, the wizard saw the concentric fire licking the walls. For a moment, he thought of taking refuge in the water, but then he understood that death was coming to crown his old age and absolve him from his labors. He walked toward the sheets of flame. They did not bite his flesh, they caressed him and flooded him without heat or combustion. With relief, with humiliation, with terror, he understood that he also was an illusion, that someone else was dreaming him."
        }
    ]
},


    diamonds: {
        suit: '♦',
        cards: [
            {
                title: "The Historical Note",
            text:
                `To Victoria Ocampo

                In his A History of the World War (page 212), Captain Liddell Hart reports that a planned offensive by thirteen British divisions, supported by fourteen hundred artillery pieces, against the German line at Serre-Montauban, scheduled for July 24, 1916, had to be postponed until the morning of the 29th. He comments that torrential rain caused this delay - which lacked any special significance. The following deposition, dictated by, read over, and then signed by Dr. Yu Tsun, former teacher of English at the Tsingtao Hochschule, casts unsuspected light upon this event. The first two pages are missing.`,
            branches: { '1': 'Continue (missing pages)', '2': 'Jump ahead' }
        },
        {
            title: "The Voice on the Phone",
            text:
                `. . . and I hung up the phone. Immediately I recollected the voice that had spoken in German. It was that of Captain Richard Madden. Madden, in Viktor Runeberg's office, meant the end of all our work and - though this seemed a secondary matter, or should have seemed so to me - of our lives also. His being there meant that Runeberg had been arrested or murdered. Before the sun set on this same day, I ran the same risk. Madden was implacable. Rather, to be more accurate, he was obliged to be implacable. An Irishman in the service of England, a man suspected of equivocal feelings if not of actual treachery, how could he fail to welcome and seize upon this extraordinary piece of luck: the discovery, capture and perhaps the deaths of two agents of Imperial Germany?`,
            branches: { '2': 'Go to the bedroom', '3': 'Name the Secret' }
        },
        {
            title: "The Day Without Omens",
            text:
              `I went up to my bedroom. Absurd though the gesture was, I closed and locked the door. I threw myself down on my narrow iron bed, and waited on my back. The never changing rooftops filled the window, and the hazy six o'clock sun hung in the sky. It seemed incredible that this day, a day without warnings or omens, might be that of my implacable death. In despite of my dead father, in despite of having been a child in one of the symmetrical gardens of Hai Feng, was I to die now?
                Then I reflected that all things happen, happen to one, precisely now. Century follows century, and things happen only in the present. There are countless men in the air, on land and at sea, and all that really happens happens to me . . . The almost unbearable memory of Madden's long horseface put an end to these wandering thoughts.`,
            branches: { '3': 'The Secret', '4': 'The Plan' }
        },
        {
            title: "The Secret",
            text:
                `In the midst of my hatred and terror (now that it no longer matters to me to speak of terror, now that I have outwitted Richard Madden, now that my neck hankers for the hangman's noose), I knew that the fast-moving and doubtless happy soldier did not suspect that I possessed the Secret - the name of the exact site of the new British artillery park on the Ancre. A bird streaked across the misty sky and, absently, I turned it into an airplane and then that airplane into many in the skies of France, shattering the artillery park under a rain of bombs. If only my mouth, before it should be silenced by a bullet, could shout this name in such a way that it could be heard in Germany ... My voice, my human voice, was weak. How could it reach the ear of the Chief? The ear of that sick and hateful man who knew nothing of Runeberg or of me except that we were in Staffordshire. A man who, sitting in his arid Berlin office, leafed infinitely through newspapers, looking in vain for news from us. I said aloud, "I must flee."`,
            branches: { '4': 'The Plan', '5': 'The Journey Begins' }
        },
        {
            title: "The Plan",
            text:
                `I sat up on the bed, in senseless and perfect silence, as if Madden was already peering at me. Something - perhaps merely a desire to prove my total penury to myself - made me empty out my pockets. I found just what I knew I was going to find. The American watch, the nickel-plated chain and the square coin, the key ring with the useless but compromising keys to Runeberg's office, the notebook, a letter which I decided to destroy at once (and which I did not destroy), a five shilling piece, two single shillings and some pennies, a red and blue pencil, a handkerchief - and a revolver with a single bullet. Absurdly I held it and weighed it in my hand, to give myself courage. Vaguely I thought that a pistol shot can be heard for a great distance.

                In ten minutes I had developed my plan. The telephone directory gave me the name of the one person capable of passing on the information. He lived in a suburb of Fenton, less than half an hour away by train.`,
            branches: { '5': 'The Journey Begins', '6': 'The Train' }
        },
        {
            title: "The Journey Begins",
            text:
                `I am a timorous man. I can say it now, now that I have brought my incredibly risky plan to an end. It was not easy to bring about, and I know that its execution was terrible. I did not do it for Germany - no! Such a barbarous country is of no importance to me, particularly since it had degraded me by making me become a spy. Furthermore, I knew an Englishman - a modest man - who, for me, is as great as Goethe. I did not speak with him for more than an hour, but during that time, he was Goethe.

                I carried out my plan because I felt the Chief had some fear of those of my race, of those uncountable forebears whose culmination lies in me. I wished to prove to him that a yellow man could save his armies. Besides, I had to escape the Captain. His hands and voice could, at any moment, knock and beckon at my door.

                Silently, I dressed, took leave of myself in the mirror, went down the stairs, sneaked a look at the quiet street, and went out. The station was not far from my house, but I thought it more prudent to take a cab. I told myself that I thus ran less chance of being recognized. The truth is that, in the deserted street, I felt infinitely visible and vulnerable. I recall that I told the driver to stop short of the main entrance. I got out with a painful and deliberate slowness.`,
            branches: { '6': 'The Train', '7': 'Ashgrove' }
        },
        {
            title: "The Train",
            text:
                `I was going to the village of Ashgrove, but took a ticket for a station further on. The train would leave in a few minutes, at eight-fifty. I hurried, for the next would not go until half past nine. There was almost no one on the platform. I walked through the carriages. I remember some farmers, a woman dressed in mourning, a youth deep in Tacitus' Annals and a wounded, happy soldier.

                At last the train pulled out. A man I recognized ran furiously, but vainly, the length of the platform. It was Captain Richard Madden. Shattered, trembling, I huddled in the distant corner of the seat, as far as possible from the fearful window.

                From utter terror I passed into a state of almost abject happiness. I told myself that the duel had already started and that I had won the first encounter by besting my adversary in his first attack - even if it was only for forty minutes - by an accident of fate. I argued that so small a victory prefigured a total victory. I argued that it was not so trivial, that were it not for the precious accident of the train schedule, I would be in prison or dead. I argued, with no less sophism, that my timorous happiness was proof that I was man enough to bring this adventure to a successful conclusion. From my weakness I drew strength that never left me.

                I foresee that man will resign himself each day to new abominations, that soon only soldiers and bandits will be left. To them I offer this advice: Whosoever would undertake some atrocious enterprise should act as if it were already accomplished, should impose upon himself a future as irrevocable as the past.

                Thus I proceeded, while with the eyes of a man already dead, I contemplated the fluctuations of the day which would probably be my last, and watched the diffuse coming of night.`,
            branches: { '7': 'Ashgrove', '8': "The Labyrinth of Ts'ui Pen" }
        },
        {
            title: "Ashgrove",
            text:
                `The train crept along gently, amid ash trees. It slowed down and stopped, almost in the middle of a field. No one called the name of a station. "Ashgrove?" I asked some children on the platform. "Ashgrove," they replied. I got out.

                A lamp lit the platform, but the children's faces remained in a shadow. One of them asked me: "Are you going to Dr. Stephen Albert's house?" Without waiting for my answer, another said: "The house is a good distance away but you won't get lost if you take the road to the left and bear to the left at every crossroad." I threw them a coin (my last), went down some stone steps and started along a deserted road. At a slight incline, the road ran downhill. It was a plain dirt way, and overhead the branches of trees intermingled, while a round moon hung low in the sky as if to keep me company.`,
            branches: { '8': "Take the left road", '9': 'Toward the gate' }
        },
        {
            title: "The Labyrinth of Ts'ui Pen",
            text:
                `For a moment I thought that Richard Madden might in some way have divined my desperate intent. At once I realized that this would be impossible. The advice about turning always to the left reminded me that such was the common formula for finding the central courtyard of certain labyrinths. I know something about labyrinths. Not for nothing am I the great-grandson of Ts'ui Pen. He was Governor of Yunnan and gave up temporal power to write a novel with more characters than there are in the Hung Lou Meng, and to create a maze in which all men would lose themselves. He spent thirteen years on these oddly assorted tasks before he was assassinated by a stranger. His novel had no sense to it and nobody ever found his labyrinth.

                Under the trees of England I meditated on this lost and perhaps mythical labyrinth. I imagined it untouched and perfect on the secret summit of some mountain; I imagined it drowned under rice paddies or beneath the sea; I imagined it infinite, made not only of eight-sided pavilions and of twisting paths but also of rivers, provinces and kingdoms ... I thought of a maze of mazes, of a sinuous, ever growing maze which would take in both past and future and would somehow involve the stars.

                Lost in these imaginary illusions I forgot my destiny - that of the hunted. For an undetermined period of time I felt myself cut off from the world, an abstract spectator. The hazy and murmuring countryside, the moon, the decline of the evening, stirred within me. Going down the gently sloping road I could not feel fatigue. The evening was at once intimate and infinite.

                The road kept descending and branching off, through meadows misty in the twilight. A high-pitched and almost syllabic music kept coming and going, moving with the breeze, blurred by the leaves and by distance.

                I thought that a man might be an enemy of other men, of the differing moments of other men, but never an enemy of a country: not of fireflies, words, gardens, streams, or the West wind.`,
            branches: { '9': 'The Gate', '10': "Stephen Albert's Library" }
        },
        {
            title: "The Gate",
            text:
                `Meditating thus I arrived at a high, rusty iron gate. Through the railings I could see an avenue bordered with poplar trees and also a kind of summer house or pavilion. Two things dawned on me at once, the first trivial and the second almost incredible: the music came from the pavilion and that music was Chinese. That was why I had accepted it fully, without paying it any attention. I do not remember whether there was a bell, a push-button, or whether I attracted attention by clapping my hands. The stuttering sparks of the music kept on.

                But from the end of the avenue, from the main house, a lantern approached; a lantern which alternately, from moment to moment, was crisscrossed or put out by the trunks of the trees; a paper lantern shaped like a drum and colored like the moon. A tall man carried it. I could not see his face for the light blinded me.

                He opened the gate and spoke slowly in my language.

                "I see that the worthy Hsi P'eng has troubled himself to see to relieving my solitude. No doubt you want to see the garden?"

                Recognizing the name of one of our consuls, I replied, somewhat taken aback.

                "The garden?"

                "The garden of forking paths."

                Something stirred in my memory and I said, with incomprehensible assurance:

                "The garden of my ancestor, Ts'ui Pen."

                "Your ancestor? Your illustrious ancestor? Come in."

                `,
            branches: { '10': "Stephen Albert's Library", '11': 'The Shot' }
        },
        {
            title: "Stephen Albert's Library",
            text:
                `The damp path zigzagged like those of my childhood. When we reached the house, we went into a library filled with books from both East and West. I recognized some large volumes bound in yellow silk-manuscripts of the Lost Encyclopedia which was edited by the Third Emperor of the Luminous Dynasty. They had never been printed. A phonograph record was spinning near a bronze phoenix. I remember also a rose-glazed jar and yet another, older by many centuries, of that blue color which our potters copied from the Persians . . .

                Stephen Albert was watching me with a smile on his face. He was, as I have said, remarkably tall. His face was deeply lined and he had gray eyes and a gray beard. There was about him something of the priest, and something of the sailor. Later, he told me he had been a missionary in Tientsin before he "had aspired to become a Sinologist."

                We sat down, I upon a large, low divan, he with his back to the window and to a large circular clock. I calculated that my pursuer, Richard Madden, could not arrive in less than an hour. My irrevocable decision could wait.

                "A strange destiny," said Stephen Albert, "that of Ts'ui Pen - Governor of his native province, learned in astronomy, in astrology and tireless in the interpretation of the canonical books, a chess player, a famous poet and a calligrapher. Yet he abandoned all to make a book and a labyrinth. He gave up all the pleasures of oppression, justice, of a well-stocked bed, of banquets, and even of erudition, and shut himself up in the Pavilion of the Limpid Sun for thirteen years. At his death, his heirs found only a mess of manuscripts. The family, as you doubtless know, wished to consign them to the fire, but the executor of the estate - a Taoist or a Buddhist monk - insisted on their publication."

                "Those of the blood of Ts'ui Pen," I replied, "still curse the memory of that monk. Such a publication was madness. The book is a shapeless mass of contradictory rough drafts. I examined it once upon a time: the hero dies in the third chapter, while in the fourth he is alive. As for that other enterprise of Ts'ui Pen ... his Labyrinth . . ."

                "Here is the Labyrinth," Albert said, pointing to a tall, lacquered writing cabinet.

                "An ivory labyrinth?" I exclaimed. "A tiny labyrinth indeed . . . !"

                "A symbolic labyrinth," he corrected me. "An invisible labyrinth of time. I, a barbarous Englishman, have been given the key to this transparent mystery. After more than a hundred years most of the details are irrecoverable, lost beyond all recall, but it isn't hard to image what must have happened. At one time, Ts'ui Pen must have said; 'I am going into seclusion to write a book,' and at another, 'I am retiring to construct a maze.' Everyone assumed these were separate activities. No one realized that the book and the labyrinth were one and the same. The Pavilion of the Limpid Sun was set in the middle of an intricate garden. This may have suggested the idea of a physical maze.

                "Ts'ui Pen died. In all the vast lands which once belonged to your family, no one could find the labyrinth. The novel's confusion suggested that it was the labyrinth. Two circumstances showed me the direct solution to the problem. First, the curious legend that Ts'ui Pen had proposed to create an infinite maze, second, a fragment of a letter which I discovered."

                Albert rose. For a few moments he turned his back to me. He opened the top drawer in the high black and gilded writing cabinet. He returned holding in his hand a piece of paper which had once been crimson but which had faded with the passage of time: it was rose colored, tenuous, quadrangular. Ts'ui Pen's calligraphy was justly famous. Eagerly, but without understanding, I read the words which a man of my own blood had written with a small brush: "I leave to various future times, but not to all, my garden of forking paths."

                I handed back the sheet of paper in silence. Albert went on:

                "Before I discovered this letter, I kept asking myself how a book could be infinite. I could not imagine any other than a cyclic volume, circular. A volume whose last page would be the same as the first and so have the possibility of continuing indefinitely. I recalled, too, the night in the middle of The Thousand and One Nights when Queen Scheherezade, through a magical mistake on the part of her copyist, started to tell the story of The Thousand and One Nights, with the risk of again arriving at the night upon which she will relate it, and thus on to infinity. I also imagined a Platonic hereditary work, passed on from father to son, to which each individual would add a new chapter or correct, with pious care, the work of his elders.

                "These conjectures gave me amusement, but none seemed to have the remotest application to the contradictory chapters of Ts'ui Pen. At this point, I was sent from Oxford the manuscript you have just seen.

                "Naturally, my attention was caught by the sentence, 'I leave to various future times, but not to all, my garden of forking paths: I had no sooner read this, than I understood. The Garden of Forking Paths was the chaotic novel itself. The phrase 'to various future times, but not to all' suggested the image of bifurcating in time, not in space. Rereading the whole work confirmed this theory. In all fiction, when a man is faced with alternatives he chooses one at the expense of the others. In the almost unfathomable Ts'ui Pen, he chooses - simultaneously - all of them. He thus creates various futures, various times which start others that will in their turn branch out and bifurcate in other times. This is the cause of the contradictions in the novel.

                "Fang, let us say, has a secret. A stranger knocks at his door. Fang makes up his mind to kill him. Naturally there are various possible outcomes. Fang can kill the intruder, the intruder can kill Fang, both can be saved, both can die and so on and so on. In Ts'ui Pen's work, all the possible solutions occur, each one being the point of departure for other bifurcations. Sometimes the pathways of this labyrinth converge. For example, you come to this house; but in other possible pasts you are my enemy; in others my friend.

                "If you will put up with my atrocious pronunciation, I would like to read you a few pages of your ancestor's work."

                His countenance, in the bright circle of lamplight, was certainly that of an ancient, but it shone with something unyielding, even immortal.

                With slow precision, he read two versions of the same epic chapter. In the first, an army marches into battle over a desolate mountain pass. The bleak and somber aspect of the rocky landscape made the soldiers feel that life itself was of little value, and so they won the battle easily. In the second, the same army passes through a palace where a banquet is in progress. The splendor of the feast remained a memory throughout the glorious battle, and so victory followed.

                With proper veneration I listened to these old tales, although perhaps with less admiration for them in themselves than for the fact that they had been thought out by one of my own blood, and that a man of a distant empire had given them back to me, in the last stage of a desperate adventure, on a Western island. I remember the final words, repeated at the end of each version like a secret command: "Thus the heroes fought, with tranquil heart and bloody sword. They were resigned to killing and to dying."

                At that moment I felt within me and around me something invisible and intangible pullulating. It was not the pullulation of two divergent, parallel, and finally converging armies, but an agitation more inaccessible, more intimate, prefigured by them in some way. Stephen Albert continued:

                "I do not think that your illustrious ancestor toyed idly with variations. I do not find it believable that he would waste thirteen years laboring over a never ending experiment in rhetoric. In your country the novel is an inferior genre; in Ts'ui Pen's period, it was a despised one. Ts'ui Pen was a fine novelist but he was also a man of letters who, doubtless, considered himself more than a mere novelist. The testimony of his contemporaries attests to this, and certainly the known facts of his life confirm his leanings toward the metaphysical and the mystical. Philosophical conjectures take up the greater part of his novel. I know that of all problems, none disquieted him more, and none concerned him more than the profound one of time. Now then, this is the only problem that does not figure in the pages of The Garden. He does not even use the word which means time. How can these voluntary omissions be explained?"

                I proposed various solutions, all of them inadequate. We discussed them. Finally Stephen Albert said: "In a guessing game to which the answer is chess, which word is the only one prohibited?" I thought for a moment and then replied:

                "The word is chess."

                "Precisely," said Albert. "The Garden of Forking Paths is an enormous guessing game, or parable, in which the subject is time. The rules of the game forbid the use of the word itself. To eliminate a word completely, to refer to it by means of inept phrases and obvious paraphrases, is perhaps the best way of drawing attention to it. This, then, is the tortuous method of approach preferred by the oblique Ts'ui Pen in every meandering of his interminable novel. I have gone over hundreds of manuscripts, I have corrected errors introduced by careless copyists, I have worked out the plan from this chaos, I have restored, or believe I have restored, the original. I have translated the whole work. I can state categorically that not once has the word time been used in the whole book.

                "The explanation is obvious. The Garden of Forking Paths is a picture, incomplete yet not false, of the universe such as Ts'ui Pen conceived it to be. Differing from Newton and Schopenhauer, your ancestor did not think of time as absolute and uniform. He believed in an infinite series of times, in a dizzily growing, ever spreading network of diverging, converging and parallel times. This web of time - the strands of which approach one another, bifurcate, intersect or ignore each other through the centuries - embraces every possibility. We do not exist in most of them. In some you exist and not I, while in others I do, and you do not, and in yet others both of us exist. In this one, in which chance has favored me, you have come to my gate. In another, you, crossing the garden, have found me dead. In yet another, I say these very same words, but am an error, a phantom."

                "In all of them," I enunciated, with a tremor in my voice. "I deeply appreciate and am grateful to you for the restoration of Ts'ui Pen's garden."

                "Not in all," he murmured with a smile. "Time is forever dividing itself toward innumerable futures and in one of them I am your enemy."

                Once again I sensed the pullulation of which I have already spoken. It seemed to me that the dew-damp garden surrounding the house was infinitely saturated with invisible people. All were Albert and myself, secretive, busy and multiform in other dimensions of time. I lifted my eyes and the short nightmare disappeared. In the black and yellow garden there was only a single man, but this man was as strong as a statue and this man was walking up the path and he was Captain Richard Madden.`,
            branches: { '11': 'The Shot' }
        },
        {
            title: "The Shot",
            text:
                `"The future exists now," I replied. "But I am your friend. Can I take another look at the letter?"

                Albert rose from his seat. He stood up tall as he opened the top drawer of the high writing cabinet. For a moment his back was again turned to me. I had the revolver ready. I fired with the utmost care: Albert fell without a murmur, at once. I swear that his death was instantaneous, as if he had been struck by lightning.

                What remains is unreal and unimportant. Madden broke in and arrested me. I have been condemned to hang. Abominably, I have yet triumphed! The secret name of the city to be attacked got through to Berlin. Yesterday it was bombed. I read the news in the same English newspapers which were trying to solve the riddle of the murder of the learned Sinologist Stephen Albert by the unknown Yu Tsun. The Chief, however, had already solved this mystery. He knew that my problem was to shout, with my feeble voice, above the tumult of war, the name of the city called Albert, and that I had no other course open to me than to kill someone of that name. He does not know, for no one can, of my infinite penitence and sickness of the heart.`,
            branches: {}
        }
    ]
}
};

// ===== GLOBAL VARIABLES =====
let currentSuit = '';
let shuffledCards = []; // fan order list
let isCardExpanded = false;
let currentExpandedOriginalIndex = null;

let gridNavEnabled = false;
let gridNavIndex = 0; // 0..11
let openedFromGrid = false;

let gridCompletionDone = false; // ✅ prevents re-flip / re-run
let navButtonsBound = false;    // ✅ prevents duplicate listeners

// Reading tracking
let readCards = {};
let cardReadCount = {};
let pageCounter = 1;
let readingPath = [];

// Grid last-read tracking
let lastReadCard = null;
let lastReadCardIndex = null;
let activeBranchGlowTarget = null;

// Initialize tracking for all suits
const suits = ['hearts', 'spades', 'diamonds'];
suits.forEach(suit => {
  readCards[suit] = new Array(12).fill(false);
  cardReadCount[suit] = new Array(12).fill(0);
});

// ===== HELPERS =====
function buildIndexedDeck(cards) {
  return cards.map((card, originalIndex) => ({ ...card, originalIndex }));
}

function getExpandedTitleForCard(suit, cardData, originalIndex) {
  if (cardData && cardData.title) return String(cardData.title);
  if (suit === 'hearts') return `Page ${pageCounter}`;
  return `Card ${originalIndex + 1}`;
}

function getGridTitleForCard(suit, originalIndex) {
  const card = storyData?.[suit]?.cards?.[originalIndex];
  if (card && card.title) return String(card.title);
  return `Card ${originalIndex + 1}`;
}

function escapeHTML(str) {
  return String(str).replace(/[&<>"']/g, (m) => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;"
  }[m]));
}

function stripBranchMarkup(text) {
  return String(text).replace(/\[BRANCH:[^:]+:([^\]]+)\]/g, "$1");
}

function getFirstTimeText(suit, index) {
  const card = storyData[suit].cards[index];
  if (!card) return "";

  if (suit === "hearts") {
    const texts = card.texts || [];
    return texts[0] || "";
  }

  if (suit === "diamonds") {
    return stripBranchMarkup(card.text || "");
  }

  return card.text || "";
}

// ===== PENDING SUIT ON LOAD =====
(function applyPendingSuitOnLoad() {
  try {
    const pending = localStorage.getItem("pendingSuit");
    if (!pending) return;
    localStorage.removeItem("pendingSuit");

    // Wait for page to load, then initialize the pending suit
    window.addEventListener("load", () => {
      setTimeout(() => {
        // Hide suit selection if it exists
        const suitSelection = document.getElementById('suitSelection');
        const mainContent = document.getElementById('mainContent');
        
        if (suitSelection) suitSelection.style.display = 'none';
        if (mainContent) mainContent.style.display = 'block';
        
        // Initialize the deck with the pending suit
        initializeDeck(pending);
      }, 50);
    });
  } catch (e) {
    console.error('Error applying pending suit:', e);
  }
})();

// ===== LOCAL STORAGE =====
function loadProgress() {
  const saved = localStorage.getItem('borgesProgress');
  if (saved) {
    const data = JSON.parse(saved);
    readCards = data.readCards || readCards;
    cardReadCount = data.cardReadCount || cardReadCount;
    pageCounter = data.pageCounter || 1;
    readingPath = data.readingPath || [];
  }
}

function saveProgress() {
  localStorage.setItem('borgesProgress', JSON.stringify({
    readCards,
    cardReadCount,
    pageCounter,
    readingPath
  }));
}

// ===== INITIALIZATION =====
function initializeDeck(suit) {
  currentSuit = suit;
  loadProgress();

  const cardsContainer = document.getElementById('cardsContainer');
  const overlay = document.getElementById('cardOverlay');
  const closeButton = document.getElementById('closeCard');

  const story = storyData[suit];

  shuffledCards = buildIndexedDeck(story.cards);
  shuffleArray(shuffledCards);

  setTimeout(() => {
    createCards(cardsContainer, story.suit);
  }, 300);
  updateBackgroundImageOrientation();

  if (closeButton) closeButton.addEventListener('click', closeExpandedCard);

  if (overlay) {
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) closeExpandedCard();
    });

    // Bind skip button
    const skipBtn = document.getElementById('skipToGridBtn');
    if (skipBtn) {
      skipBtn.addEventListener('click', skipToGrid);
    }
  }

  // ✅ Bind arrows immediately (they exist in HTML)
  bindNavButtons();

  document.addEventListener('keydown', (e) => {
    if (!isCardExpanded) return;

    if (e.key === 'Escape') closeExpandedCard();
    if (e.key === 'ArrowLeft') goPrevGridCard();
    if (e.key === 'ArrowRight') goNextGridCard();
  });
}

function bindNavButtons() {
  if (navButtonsBound) return;

  const prevBtn = document.getElementById('prevCard');
  const nextBtn = document.getElementById('nextCard');

  if (!prevBtn || !nextBtn) {
    console.error('Navigation buttons not found in DOM');
    return;
  }

  // LEFT arrow = go to LOWER index
  prevBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    if (!gridNavEnabled || !openedFromGrid) return;
    openGridCardAtIndex(gridNavIndex - 1);
  });

  // RIGHT arrow = go to HIGHER index
  nextBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    if (!gridNavEnabled || !openedFromGrid) return;
    openGridCardAtIndex(gridNavIndex + 1);
  });

  navButtonsBound = true;

  // Ensure correct initial state
  updateGridNavArrows();
}

function updateGridNavArrows() {
  const prevBtn = document.getElementById('prevCard');
  const nextBtn = document.getElementById('nextCard');
  if (!prevBtn || !nextBtn) return;

  // Show arrows only when grid nav is active + opened from grid
  const shouldShow = Boolean(gridNavEnabled && openedFromGrid);
  const overlay = document.getElementById('cardOverlay');
  if (overlay) {
    overlay.classList.toggle('grid-nav-on', shouldShow);
  }

  if (!shouldShow) {
    prevBtn.classList.add('disabled');
    nextBtn.classList.add('disabled');
    return;
  }

  // Card 0: only RIGHT (next). Card 11: only LEFT (prev). Middle: both.
  if (gridNavIndex <= 0) {
    prevBtn.classList.add('disabled');
    nextBtn.classList.remove('disabled');
  } else if (gridNavIndex >= 11) {
    prevBtn.classList.remove('disabled');
    nextBtn.classList.add('disabled');
  } else {
    prevBtn.classList.remove('disabled');
    nextBtn.classList.remove('disabled');
  }
}

// ===== SHUFFLE =====
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// ===== FAN (BOTTOM) =====
function createCards(container, suitSymbol) {
  container.innerHTML = '';

  const cardCount = shuffledCards.length;
  const containerWidth = window.innerWidth;
  const cardWidth = window.innerWidth > 768 ? 140 : (window.innerWidth > 480 ? 100 : 80);

  const totalSpread = Math.min(containerWidth * 0.8, Math.max(cardCount, 1) * 40);
  const angleStep = 3;
  const maxAngle = cardCount > 1 ? ((cardCount - 1) * angleStep / 2) : 0;

  shuffledCards.forEach((cardData, displayIndex) => {
    const cardElement = createCardElement(cardData, suitSymbol);

    const position = calculateFanPosition(displayIndex, cardCount, totalSpread, maxAngle, cardWidth);
    cardElement.style.left = `${position.x}px`;
    cardElement.style.bottom = `${position.y}px`;
    cardElement.style.transform = `rotate(${position.rotation}deg)`;
    cardElement.style.zIndex = displayIndex;
    cardElement.style.animationDelay = `${displayIndex * 0.05}s`;

    cardElement.addEventListener('click', function () {
      const originalIndex = Number(this.dataset.originalIndex);
      expandCard(cardData, suitSymbol, this, originalIndex);
    });

    container.appendChild(cardElement);
  });
}

function createCardElement(cardData, suitSymbol) {
  const el = document.createElement('div');
  el.className = 'card';

  el.dataset.originalIndex = String(cardData.originalIndex);
  el.setAttribute('data-original-index', String(cardData.originalIndex));

  const isRead = readCards[currentSuit][cardData.originalIndex];
  if (isRead) el.classList.add('read');

  el.style.backgroundImage = `url('card-images/${currentSuit}-${cardData.originalIndex}.jpg')`;
  el.style.backgroundSize = 'cover';
  el.style.backgroundPosition = 'center';

  return el;
}

function calculateFanPosition(index, totalCards, totalSpread, maxAngle, cardWidth) {
  const centerX = window.innerWidth / 2;

  if (totalCards <= 1) {
    return { x: centerX - (cardWidth / 2), y: 0, rotation: 0 };
  }

  const spreadStart = centerX - (totalSpread / 2);
  const x = spreadStart + (index * (totalSpread / (totalCards - 1))) - (cardWidth / 2);

  const rotation = -maxAngle + (index * (maxAngle * 2 / (totalCards - 1)));

  const normalizedPosition = (index / (totalCards - 1)) - 0.5;
  const arcHeight = 40;
  const y = -Math.abs(normalizedPosition) * arcHeight;

  return { x, y, rotation };
}

// ===== EXPAND (FAN CARD) - First time reading =====
function expandCard(cardData, suitSymbol, clickedElement, cardIndex) {
  if (isCardExpanded) return;
  openedFromGrid = false; // ✅ This is first-time reading
  isCardExpanded = true;

  const overlay = document.getElementById('cardOverlay');
  if (overlay) overlay.classList.remove('grid-nav-on'); // ✅ Hide arrows for first-time reading

  const expandedCard = document.getElementById('expandedCard');
  const cardContent = document.getElementById('cardContent');
  const cardFront = expandedCard.querySelector('.card-front');

  const clickedCard = clickedElement;

  readCards[currentSuit][cardIndex] = true;
  cardReadCount[currentSuit][cardIndex]++;
  readingPath.push({ suit: currentSuit, index: cardIndex });
  saveProgress();

  clickedCard.classList.add('read');

  storeLastReadCard(cardData, cardIndex);

  const cardTitle = getExpandedTitleForCard(currentSuit, cardData, cardIndex);

  let textContent = '';
  if (currentSuit === 'hearts') {
    const counterElement = document.getElementById('pageCounter');
    if (counterElement) {
      counterElement.textContent = `Page ${pageCounter}`;
      counterElement.classList.add('updated');
      setTimeout(() => counterElement.classList.remove('updated'), 500);
    }

    pageCounter++;
    saveProgress();

    const texts = cardData.texts || [''];
    const readCount = cardReadCount[currentSuit][cardIndex] - 1;
    const textIndex = readCount % texts.length;
    textContent = texts[textIndex];
  } else {
    textContent = cardData.text || '';
  }

  textContent = processTextMarkup(textContent, cardData);

  cardFront.style.backgroundImage = clickedCard.style.backgroundImage;
  cardFront.style.backgroundSize = 'cover';
  cardFront.style.backgroundPosition = 'center';

  cardContent.innerHTML = `
    <h2 style="font-size: 1.5rem; margin-bottom: 1.5rem; text-align: center; color: var(--card-text);">
      ${cardTitle}
    </h2>
    <p style="white-space: pre-wrap;">${textContent}</p>
  `;

  const cardBack = expandedCard.querySelector('.card-back');
  cardBack.scrollTop = 0;
  requestAnimationFrame(() => { cardBack.scrollTop = 0; });

  if (overlay) overlay.classList.add('active');

  currentExpandedOriginalIndex = cardIndex;

  clickedCard.style.opacity = '0';
  clickedCard.style.pointerEvents = 'none';

  shuffledCards = shuffledCards.filter(c => c.originalIndex !== cardIndex);

  // animate in + flip
  expandedCard.style.transition = 'none';
  expandedCard.style.transform = 'translateY(0) scale(0.5)';
  expandedCard.style.opacity = '0';
  expandedCard.offsetHeight;

  expandedCard.style.transition = 'all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)';
  expandedCard.style.transform = 'translateY(-80px) scale(1)';
  expandedCard.style.opacity = '1';

  setTimeout(() => {
    expandedCard.classList.add('flipped');
    setTimeout(() => {
      cardContent.addEventListener('click', handleContentClick);
    }, 400);
  }, 700);

  updateNavArrows(true); // ✅ Hide arrows during first-time reading
}

// ===== TEXT MARKUP (BRANCH CHOICES) =====
function processTextMarkup(text, cardData) {
  const safeText = String(text);

  const branches = cardData && cardData.branches ? cardData.branches : {};
  const keys = Object.keys(branches);
  if (keys.length === 0) return safeText;

  const choicesHTML = `
    <div class="branch-choices" style="margin-top: 18px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
      ${keys.map(k => {
        const label = branches[k];
        return `<span class="branch-link" data-branch="${k}">${label}</span>`;
      }).join('')}
    </div>
  `;

  return safeText + choicesHTML;
}

// ===== CLOSE OVERLAY =====
function closeExpandedCard() {
  if (!isCardExpanded) return;

  const overlay = document.getElementById('cardOverlay');
  const expandedCard = document.getElementById('expandedCard');
  const cardContent = document.getElementById('cardContent');

  cardContent.removeEventListener('click', handleContentClick);
  expandedCard.classList.remove('flipped');

  setTimeout(() => {
    expandedCard.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
    expandedCard.style.transform = 'translateY(0) scale(0.5)';
    expandedCard.style.opacity = '0';

    setTimeout(() => {
      if (overlay) overlay.classList.remove('active');
      if (overlay) overlay.classList.remove('grid-nav-on');
      expandedCard.style.transition = 'none';
      expandedCard.style.transform = '';
      expandedCard.style.opacity = '1';
      isCardExpanded = false;
      openedFromGrid = false;
      updateGridNavArrows();

      if (!openedFromGrid) {
        addCardToGrid();
        checkGridCompletion();
        currentExpandedOriginalIndex = null;
        reshuffleFan();
      } else {
        updateNavArrows(false);
      }
    }, 500);
  }, 400);
}

// ===== RESHUFFLE FAN =====
function reshuffleFan() {
  const container = document.getElementById('cardsContainer');
  if (!container) return;

  const story = storyData[currentSuit];
  if (!story) return;

  shuffleArray(shuffledCards);
  createCards(container, story.suit);
}

// ===== BRANCH CLICK HANDLER =====
function triggerBranchGlow(target, duration = 4500) {
  if (!target) return;

  if (activeBranchGlowTarget && activeBranchGlowTarget !== target) {
    activeBranchGlowTarget.classList.remove('branch-target-active');
  }
  activeBranchGlowTarget = target;
  target.classList.add('branch-target-active');

  target.classList.remove('highlight-pulse');
  // Restart CSS animation on repeated branch clicks.
  void target.offsetWidth;
  target.classList.add('highlight-pulse');

  setTimeout(() => {
    target.classList.remove('highlight-pulse');
  }, duration);
}

function glowBranchTargetByIndex(targetIndex, retries = 12) {
  const targetGrid = findGridMiniCardByIndex(targetIndex);
  if (targetGrid) {
    const gridCell = targetGrid.closest('.grid-cell');
    if (gridCell) {
      triggerBranchGlow(gridCell);
      return true;
    }
  }

  const targetCard = findCardByIndex(targetIndex);
  if (targetCard) {
    triggerBranchGlow(targetCard);
    return true;
  }

  if (retries > 0) {
    setTimeout(() => {
      glowBranchTargetByIndex(targetIndex, retries - 1);
    }, 90);
  }

  return false;
}

function handleContentClick(e) {
  const branchLink = e.target.closest('.branch-link');
  if (!branchLink) return;

  const targetIndex = parseInt(branchLink.getAttribute('data-branch'), 10);
  if (Number.isNaN(targetIndex)) return;

  closeExpandedCard();

  // Wait until close animation + fan/grid updates finish, then glow.
  setTimeout(() => {
    glowBranchTargetByIndex(targetIndex);
  }, 980);
}

function findCardByIndex(index) {
  const cards = document.querySelectorAll('.card');
  for (let card of cards) {
    const oi = parseInt(card.getAttribute('data-original-index') || card.dataset.originalIndex, 10);
    if (oi === index) return card;
  }
  return null;
}

function findGridMiniCardByIndex(index) {
  const grid = document.getElementById('reconstructionGrid');
  if (!grid) return null;
  return grid.querySelector(`.grid-cell[data-position="${index}"] .grid-mini-card`);
}

function getCoverVisibleRatio(imageWidth, imageHeight, viewportWidth, viewportHeight) {
  const scale = Math.max(viewportWidth / imageWidth, viewportHeight / imageHeight);
  const drawnWidth = imageWidth * scale;
  const drawnHeight = imageHeight * scale;
  return (viewportWidth * viewportHeight) / (drawnWidth * drawnHeight);
}

function updateBackgroundImageOrientation() {
  const images = document.querySelectorAll('.background-image');
  if (!images.length) return;

  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;
  const isSmallViewport = viewportWidth <= 900 || viewportHeight <= 720;

  images.forEach((img) => {
    const imageWidth = img.naturalWidth;
    const imageHeight = img.naturalHeight;

    if (!imageWidth || !imageHeight) {
      if (!img.dataset.rotateListenerBound) {
        img.dataset.rotateListenerBound = 'true';
        img.addEventListener('load', updateBackgroundImageOrientation, { once: true });
      }
      return;
    }

    const normalVisibility = getCoverVisibleRatio(imageWidth, imageHeight, viewportWidth, viewportHeight);
    const rotatedVisibility = getCoverVisibleRatio(imageHeight, imageWidth, viewportWidth, viewportHeight);

    const shouldRotate = isSmallViewport && rotatedVisibility > normalVisibility * 1.08;
    img.classList.toggle('background-image-rotated', shouldRotate);
  });
}

// ===== RESPONSIVE =====
let resizeTimeout;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    if (currentSuit && !isCardExpanded) {
      const cardsContainer = document.getElementById('cardsContainer');
      const story = storyData[currentSuit];
      if (cardsContainer && story) createCards(cardsContainer, story.suit);
    }
    updateBackgroundImageOrientation();
    updateGridInstructionMode();
  }, 250);
});

// TOUCH SUPPORT
if ('ontouchstart' in window) {
  document.addEventListener('touchstart', function () { }, { passive: true });
}

// ===== GRID PLACEMENT =====
function storeLastReadCard(cardData, cardIndex) {
  lastReadCard = cardData;
  lastReadCardIndex = cardIndex;
}

function addCardToGrid() {
  if (!lastReadCard || lastReadCardIndex === null) return;

  const grid = document.getElementById('reconstructionGrid');
  if (!grid) return;

  const cell = grid.querySelector(`.grid-cell[data-position="${lastReadCardIndex}"]`);
  if (!cell || cell.classList.contains('filled')) {
    lastReadCard = null;
    lastReadCardIndex = null;
    return;
  }

  const oi = lastReadCardIndex;

  const miniCard = document.createElement('div');
  miniCard.className = 'grid-mini-card';
  miniCard.dataset.originalIndex = String(oi);

  const front = document.createElement('div');
  front.className = 'mini-front';
  front.style.backgroundImage = `url('card-images/${currentSuit}-${oi}.jpg')`;
  front.style.backgroundSize = 'cover';
  front.style.backgroundPosition = 'center';

  const back = document.createElement('div');
  back.className = 'mini-back';

  const firstText = getFirstTimeText(currentSuit, oi);
  const safeText = escapeHTML(firstText);
  const title = getGridTitleForCard(currentSuit, oi);

  back.innerHTML = `
    <div class="mini-back-inner">
      <div class="mini-back-title">${escapeHTML(title)}</div>
      <div class="mini-back-text">${safeText}</div>
    </div>
  `;

  miniCard.appendChild(front);
  miniCard.appendChild(back);

  cell.appendChild(miniCard);
  cell.classList.add('filled');

  setTimeout(() => miniCard.classList.add('placed'), 50);

  miniCard.addEventListener('click', () => {
    if (!gridNavEnabled) return;
    openGridCardAtIndex(oi);
  });

  lastReadCard = null;
  lastReadCardIndex = null;
}

function checkGridCompletion() {
  if (gridCompletionDone) return; // ✅ prevents cards flipping again forever

  const grid = document.getElementById('reconstructionGrid');
  if (!grid) return;

  const filledCells = grid.querySelectorAll('.grid-cell.filled');
  if (filledCells.length === 12) {
    setTimeout(() => {
      animateGridCompletion();
    }, 500);
  }
}

// ===== GRID COMPLETE: FLIP ON LEFT + ENABLE NAV =====
function animateGridCompletion() {
  const grid = document.getElementById('reconstructionGrid');
  if (!grid) return;

  for (let pos = 0; pos < 12; pos++) {
    const cell = grid.querySelector(`.grid-cell[data-position="${pos}"]`);
    const card = cell ? cell.querySelector('.grid-mini-card') : null;
    if (!card) continue;

    // ✅ add flip only once; after that it stays flipped
    if (!card.classList.contains('flip-reveal')) {
      setTimeout(() => card.classList.add('flip-reveal'), pos * 120);
    }
  }

  setTimeout(() => {
    gridNavEnabled = true;
    gridCompletionDone = true; // ✅ lock completion state
    updateGridNavArrows();
  }, (12 * 120) + 300);

  runGridCompleteInstruction();
}

// ===== GRID NAV OVERLAY - Re-reading from grid =====
function openGridCardAtIndex(index) {
  const i = Math.max(0, Math.min(11, Number(index) || 0));
  gridNavIndex = i;
  openedFromGrid = true; // ✅ This is re-reading from grid
  isCardExpanded = true;

  const cardData = storyData[currentSuit].cards[i];

  const overlay = document.getElementById('cardOverlay');
  if (overlay) overlay.classList.add('grid-nav-on'); // ✅ Show arrows for grid navigation

  updateGridNavArrows();

  const expandedCard = document.getElementById('expandedCard');
  const cardContent = document.getElementById('cardContent');
  const cardFront = expandedCard.querySelector('.card-front');

  const title = getExpandedTitleForCard(currentSuit, cardData, i);

  let textContent = '';
  if (currentSuit === 'hearts') {
    const texts = cardData.texts || [''];
    textContent = texts[0] || '';
  } else {
    textContent = cardData.text || '';
  }

  textContent = processTextMarkup(textContent, cardData);

  cardFront.style.backgroundImage = `url('card-images/${currentSuit}-${i}.jpg')`;
  cardFront.style.backgroundSize = 'cover';
  cardFront.style.backgroundPosition = 'center';

  cardContent.innerHTML = `
    <h2 style="font-size: 1.5rem; margin-bottom: 1.5rem; text-align: center; color: var(--card-text);">
      ${title}
    </h2>
    <p style="white-space: pre-wrap;">${textContent}</p>
  `;

  const cardBack = expandedCard.querySelector('.card-back');
  cardBack.scrollTop = 0;
  requestAnimationFrame(() => { cardBack.scrollTop = 0; });

  if (overlay) overlay.classList.add('active');

  // ✅ Keep the card already flipped (showing back/text side)
  expandedCard.classList.add('flipped');
  
  // ✅ Animate entrance WITHOUT additional flip
  expandedCard.style.transition = 'none';
  expandedCard.style.transform = 'translateY(0) scale(0.5) rotateY(180deg)';
  expandedCard.style.opacity = '0';
  expandedCard.offsetHeight;

  expandedCard.style.transition = 'all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)';
  expandedCard.style.transform = 'translateY(-80px) scale(1) rotateY(180deg)';
  expandedCard.style.opacity = '1';

  updateNavArrows(false); // ✅ Show arrows when re-reading from grid
}

function updateNavArrows(hideAll = false) {
  const prev = document.getElementById('prevCard');
  const next = document.getElementById('nextCard');
  const overlay = document.getElementById('cardOverlay');

  if (!prev || !next) return;

  if (hideAll) {
    // First-time reading (fan): hide arrows
    if (overlay) overlay.classList.remove('grid-nav-on');
    prev.classList.add('disabled');
    next.classList.add('disabled');
    return;
  }

  // Re-reading from grid: show + correctly enable/disable
  updateGridNavArrows();
}

function goPrevGridCard() {
  console.log('goPrevGridCard called', {gridNavEnabled, openedFromGrid, gridNavIndex});
  if (!gridNavEnabled) return;
  if (!openedFromGrid) return;
  if (gridNavIndex <= 0) return;
  openGridCardAtIndex(gridNavIndex - 1); 
}

function goNextGridCard() {
  console.log('goNextGridCard called', {gridNavEnabled, openedFromGrid, gridNavIndex});
  if (!gridNavEnabled) return;
  if (!openedFromGrid) return;
  if (gridNavIndex >= 11) return;
  openGridCardAtIndex(gridNavIndex + 1); 
}

// ===== SKIP TO GRID (for testing) =====
function skipToGrid() {
  // Mark all cards as read
  for (let i = 0; i < 12; i++) {
    readCards[currentSuit][i] = true;
    cardReadCount[currentSuit][i] = 1;
  }
  
  // Clear the fan
  shuffledCards = [];
  const cardsContainer = document.getElementById('cardsContainer');
  if (cardsContainer) cardsContainer.innerHTML = '';
  
  // Add all cards to grid
  const grid = document.getElementById('reconstructionGrid');
  if (!grid) return;
  
  for (let i = 0; i < 12; i++) {
    const cell = grid.querySelector(`.grid-cell[data-position="${i}"]`);
    if (!cell || cell.classList.contains('filled')) continue;
    
    const cardData = storyData[currentSuit].cards[i];
    
    const miniCard = document.createElement('div');
    miniCard.className = 'grid-mini-card placed'; // Already add 'placed' class
    miniCard.dataset.originalIndex = String(i);
    
    const front = document.createElement('div');
    front.className = 'mini-front';
    front.style.backgroundImage = `url('card-images/${currentSuit}-${i}.jpg')`;
    front.style.backgroundSize = 'cover';
    front.style.backgroundPosition = 'center';
    
    const back = document.createElement('div');
    back.className = 'mini-back';
    
    const firstText = getFirstTimeText(currentSuit, i);
    const safeText = escapeHTML(firstText);
    const title = getGridTitleForCard(currentSuit, i);
    
    back.innerHTML = `
      <div class="mini-back-inner">
        <div class="mini-back-title">${escapeHTML(title)}</div>
        <div class="mini-back-text">${safeText}</div>
      </div>
    `;
    
    miniCard.appendChild(front);
    miniCard.appendChild(back);
    
    cell.appendChild(miniCard);
    cell.classList.add('filled');
    
    miniCard.addEventListener('click', () => {
      if (!gridNavEnabled) return;
      openGridCardAtIndex(i);
    });
  }
  
  // Save progress
  saveProgress();
  
  // Trigger grid completion animation
  setTimeout(() => {
    if (!gridCompletionDone) {
      animateGridCompletion();
    }
  }, 500);
  
  // Hide the skip button
  const skipBtn = document.getElementById('skipToGridBtn');
  if (skipBtn) skipBtn.style.display = 'none';
}

// ===== GRID INSTRUCTION TYPEWRITER + END LINKS =====
let gridSkipRequested = false;
let gridActiveTimeout = null;

let gridSkipResolve = null;
let gridSkipPromise = null;

function isSmallGridOverlayViewport() {
  return window.matchMedia("(max-width: 768px), (max-height: 760px)").matches;
}

function doRectsOverlap(a, b) {
  if (!a || !b) return false;
  return (
    a.left < b.right &&
    a.right > b.left &&
    a.top < b.bottom &&
    a.bottom > b.top
  );
}

function ensureGridInstructionCloseButton() {
  const box = document.querySelector("#gridInstructionOverlay .grid-instruction-box");
  if (!box) return null;

  let closeBtn = document.getElementById("gridInstructionClose");
  if (!closeBtn) {
    closeBtn = document.createElement("button");
    closeBtn.id = "gridInstructionClose";
    closeBtn.type = "button";
    closeBtn.className = "grid-instruction-close button-30 hidden";
    closeBtn.setAttribute("aria-label", "Close message");
    closeBtn.textContent = "×";
    box.appendChild(closeBtn);
  }

  if (!closeBtn.dataset.wired) {
    closeBtn.dataset.wired = "true";
    closeBtn.addEventListener("click", hideGridInstructionOverlay);
  }

  return closeBtn;
}

function shouldUseGridInstructionModal() {
  if (!isSmallGridOverlayViewport()) return false;

  const overlay = document.getElementById("gridInstructionOverlay");
  const box = overlay ? overlay.querySelector(".grid-instruction-box") : null;
  const grid = document.getElementById("reconstructionGrid");
  if (!overlay || !box || !grid) return false;

  return doRectsOverlap(box.getBoundingClientRect(), grid.getBoundingClientRect());
}

function updateGridInstructionMode() {
  const overlay = document.getElementById("gridInstructionOverlay");
  if (!overlay) return;

  const closeBtn = ensureGridInstructionCloseButton();
  const useModal = shouldUseGridInstructionModal();

  overlay.classList.toggle("modal-mode", useModal);
  if (closeBtn) closeBtn.classList.toggle("hidden", !useModal);
}

function resetGridSkipPromise() {
  gridSkipPromise = new Promise((resolve) => (gridSkipResolve = resolve));
}

function showGridOverlay() {
  const overlay = document.getElementById("gridInstructionOverlay");
  if (!overlay) return;
  overlay.classList.remove("hidden");
  requestAnimationFrame(updateGridInstructionMode);
}

function hideGridInstructionOverlay() {
  const overlay = document.getElementById("gridInstructionOverlay");
  if (!overlay) return;
  overlay.classList.add("hidden");
  overlay.classList.remove("modal-mode");
}

function ensureGridStoryButtonsExist() {
  let wrap = document.getElementById("gridStoryLinks");
  const typedWrap = document.getElementById("gridInstructionTyped");
  if (!typedWrap) return null;

  if (!wrap) {
    wrap = document.createElement("div");
    wrap.id = "gridStoryLinks";
    wrap.className = "hidden";
    typedWrap.appendChild(wrap);
  }

  let nextEl = document.getElementById("nextStory");
  if (!nextEl) {
    nextEl = document.createElement("div");
    nextEl.id = "nextStory";
    nextEl.className = "story-link";
    wrap.appendChild(nextEl);
  }

  let restartEl = document.getElementById("restartStory");
  if (!restartEl) {
    restartEl = document.createElement("div");
    restartEl.id = "restartStory";
    restartEl.className = "story-link";
    wrap.appendChild(restartEl);
  }

  return wrap;
}

function finishGridToEnd(fullText) {
  const textEl = document.getElementById("gridInstructionText");
  const caretEl = document.getElementById("gridInstructionCaret");
  const skipBtn = document.getElementById("gridInstructionSkip");
  const nextEl = document.getElementById("nextStory");
  const restartEl = document.getElementById("restartStory");

  if (gridActiveTimeout) {
    clearTimeout(gridActiveTimeout);
    gridActiveTimeout = null;
  }

  if (textEl) textEl.textContent = fullText;
  if (caretEl) caretEl.classList.remove("pause");
  if (skipBtn) skipBtn.classList.add("hidden");
  showGridStoryButtons();
  if (nextEl) nextEl.textContent = "What happens next?";
  if (restartEl) restartEl.textContent = "Restart.";
  updateGridInstructionMode();
}

// ---- show/hide typed link lines ----
function showGridStoryButtons() {
  const wrap = ensureGridStoryButtonsExist();
  if (!wrap) return;

  // IMPORTANT: ensure clicks are possible even if overlay CSS disables them
  wrap.style.pointerEvents = "auto";

  const nextEl = document.getElementById("nextStory");
  const restartEl = document.getElementById("restartStory");
  if (nextEl) nextEl.style.pointerEvents = "auto";
  if (restartEl) restartEl.style.pointerEvents = "auto";

  wrap.classList.remove("hidden");
}

function hideGridStoryButtons() {
  const wrap = document.getElementById("gridStoryLinks");
  if (!wrap) return;
  wrap.classList.add("hidden");
}

// cancelable sleep
function gridSleep(ms) {
  return Promise.race([
    new Promise((r) => setTimeout(r, ms)),
    gridSkipPromise
  ]);
}

function gridTypeText(text, speed = 40) {
  const textEl = document.getElementById("gridInstructionText");

  return new Promise((resolve) => {
    if (!textEl) return resolve();

    let i = 0;
    textEl.textContent = "";

    function tick() {
      if (gridSkipRequested) {
        updateGridInstructionMode();
        resolve();
        return;
      }

      textEl.textContent += text.charAt(i);
      updateGridInstructionMode();
      i++;

      if (i < text.length) {
        gridActiveTimeout = setTimeout(tick, speed);
      } else {
        gridActiveTimeout = null;
        resolve();
      }
    }

    tick();
  });
}

function gridTypeIntoEl(el, text, speed = 40) {
  return new Promise((resolve) => {
    if (!el) return resolve();

    let i = 0;
    el.textContent = "";

    function tick() {
      if (gridSkipRequested) {
        el.textContent = text;
        updateGridInstructionMode();
        resolve();
        return;
      }

      el.textContent += text.charAt(i);
      updateGridInstructionMode();
      i++;

      if (i < text.length) {
        gridActiveTimeout = setTimeout(tick, speed);
      } else {
        gridActiveTimeout = null;
        resolve();
      }
    }

    tick();
  });
}

// ===== GET RANDOM OTHER SUIT =====
function getRandomOtherSuit() {
  const suitOptions = {
    hearts: ['diamonds', 'spades'],
    diamonds: ['hearts', 'spades'],
    spades: ['hearts', 'diamonds']
  };
  const others = suitOptions[currentSuit] || suits.filter((s) => s !== currentSuit);
  if (others.length === 0) return suits[0]; // Fallback to first suit
  return others[Math.floor(Math.random() * others.length)];
}

// ===== GO TO SUIT (FIXED VERSION) =====
function goToSuit(suit) {
  const target = `${suit}.html`;
  window.location.href = target;
}

// ===== WIRE GRID STORY BUTTONS =====
function wireGridStoryButtons() {
  const wrap = document.getElementById("gridStoryLinks");
  if (!wrap || wrap.dataset.wired) return;

  wrap.dataset.wired = "true";

  // Ensure the container can actually receive clicks
  wrap.style.pointerEvents = "auto";

  wrap.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();

    const hit = e.target && e.target.closest ? e.target.closest("#nextStory, #restartStory") : null;
    if (!hit) return;

    console.log('Story button clicked:', hit.id);

    if (hit.id === "nextStory") {
      const pick = getRandomOtherSuit();
      console.log('Next story selected:', pick);
      goToSuit(pick);
    }

    if (hit.id === "restartStory") {
      console.log('Restart clicked');
      // Clear progress and reload
      try {
        localStorage.removeItem('borgesProgress');
      } catch (e) {
        console.error('Error clearing progress:', e);
      }
      window.location.reload();
    }
  });

  console.log('Grid story buttons wired');
}

// ===== TYPE BUTTONS =====
async function gridTypeButtons(speed = 40) {
  ensureGridStoryButtonsExist();
  const nextEl = document.getElementById("nextStory");
  const restartEl = document.getElementById("restartStory");
  if (!nextEl || !restartEl) return;

  // Make them feel like text links (not buttons)
  nextEl.style.cursor = "pointer";
  restartEl.style.cursor = "pointer";

  showGridStoryButtons();
  nextEl.textContent = "";
  restartEl.textContent = "";

  await gridTypeIntoEl(nextEl, "What happens next?", speed);
  await gridSleep(120);
  await gridTypeIntoEl(restartEl, "Restart.", speed);
  updateGridInstructionMode();
}

// ===== RUN GRID COMPLETE INSTRUCTION =====
async function runGridCompleteInstruction() {
  const textEl = document.getElementById("gridInstructionText");
  const caretEl = document.getElementById("gridInstructionCaret");
  const skipBtn = document.getElementById("gridInstructionSkip");
  if (!textEl || !caretEl) return;

  const message = `
All paths are visible now. 
Begin with the first card.`;

  // reset state
  gridSkipRequested = false;
  resetGridSkipPromise();

  showGridOverlay();
  hideGridStoryButtons();
  wireGridStoryButtons();   // attach click handler once

  await gridSleep(2000);
  if (gridSkipRequested) {
    finishGridToEnd(message);
    return;
  }

  await gridTypeText(message, 40);
  if (gridSkipRequested) {
    finishGridToEnd(message);
    return;
  }

  await gridSleep(450);
  if (gridSkipRequested) return;

  caretEl.classList.add("pause");
  await gridTypeButtons(40);
  await gridSleep(250);

  if (gridSkipRequested) return;
  if (skipBtn) skipBtn.classList.add("hidden");
  caretEl.classList.remove("pause");
  updateGridInstructionMode();
}

// ===== BIND SKIP BUTTON =====
document.addEventListener('DOMContentLoaded', () => {
  const skipBtn = document.getElementById("gridInstructionSkip");
  if (skipBtn) {
    skipBtn.addEventListener("click", () => {
      console.log('Skip button clicked');
      gridSkipRequested = true;
      if (gridSkipResolve) gridSkipResolve();
    });
  }
});
